---
title: "Pathway Subsets"
author: Anna L Tyler
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    code_folding: hide
    collapsed: no
    toc: yes
    toc_float: yes
---

## Introduction

The purpose of this workflow is to look for subsets
of individuals based on signaling in different pathways.
We will use the gene sets from the tissue of action
clustering as a test case.

We then do a clustering pipeline as we did in the
Cell_Type_Validation.Rmd workflow.

```{r load_code}
rm(list = ls())

#is.interactive = TRUE
library("here")

exp.name = "tissue_together-_-complete_mediation-germline_kinship"
data.results.dir <- here("Results", "High_Dim_Med", exp.name)

all.fun <- list.files(here("Code"), full.names = TRUE, pattern = ".R")
for(i in 1:length(all.fun)){source(all.fun[i])}

tissue.cols <- c("orange", "#8dd3c7", "tan", "brown") #colors that are not related to the DO/CC colors
```

```{r load_libraries, message = FALSE, warning = FALSE, error = FALSE}
all.packages <- c("pheatmap", "gprofiler2", "RColorBrewer", "GEOquery", "limma", 
    "vioplot", "pdftools")
load_libraries(all.packages, personal.library = TRUE)
```

```{r read_data}
file.names <- c("Apelin_signaling_pathway_cluster.txt", "Lep-Lepr_quaternary_protein_cluster.txt")
#file.names <- list.files(here("Results", "Gene_Sets"))

gene.set.files <- file.path(here("Results", "Gene_Sets", file.names))

gene.sets <- lapply(gene.set.files, read.table)
gene.set.names <- gsub(".txt", "", basename(gene.set.files))

model_scores <- readRDS(file.path(data.results.dir, "Model_Scores_0.RDS"))

transcript_loadings <- readRDS(file.path(data.results.dir, "Loadings_Transcripts_0.RDS"))
tissue.names <- names(transcript_loadings)

adj.expr <- readRDS(here("Results", "Data", "Tissue_Expression_Adjusted.RDS")) #generated by 1a.Tissue_Expression.Rmd

common.ind <- Reduce("intersect", lapply(adj.expr, rownames))

scaled.expr <- lapply(adj.expr, function(x) apply(x[common.ind,], 2, scale))
for(tx in 1:length(scaled.expr)){
    dimnames(scaled.expr[[tx]]) <- dimnames(adj.expr[[tx]][common.ind,])
}

pheno.score <- model_scores[[1]][common.ind,"Outcome"]
pheno.col <- colors.from.values(pheno.score, use.pheatmap.colors = TRUE)
pheno.df <- data.frame("Phenotype_Score" = pheno.score)

```


```{r subset_loadings}
#get loadings for each gene set
tx.loadings <- vector(mode = "list", length = length(tissue.names))
names(tx.loadings) <- tissue.names
for(tx in 1:length(tissue.names)){
    tx.loading <- lapply(gene.sets, function(x) transcript_loadings[[tx]][intersect(x[,1], rownames(transcript_loadings[[tx]])),,drop=FALSE])
    names(tx.loading) <- gene.set.names
    tx.loadings[[tx]] <- tx.loading
}
```


## Subsets

We can derive scores for each animal based on their expression of 
the each gene set. We can then look for subsets of animals that are 
at risk of obesity for different reasons.

```{r subsets, fig.width = 9, fig.height = 4}

set.score.mat <- matrix(NA, nrow = length(gene.set.names)*length(tissue.names), 
    ncol = length(common.ind))
set.tissue.names <- paste(rep(tissue.names, each = length(gene.set.names)), gene.set.names, sep = "_")
rownames(set.score.mat) <- set.tissue.names
colnames(set.score.mat) <- common.ind

for(tx in 1:length(tissue.names)){
    for(gs in 1:length(gene.set.names)){
        category_name <- paste(tissue.names[tx], gene.set.names[gs], sep = "_")
        common.tx <- intersect(colnames(scaled.expr[[tx]]), rownames(tx.loadings[[tx]][[gs]]))
        if(length(common.tx) == 0){next()}
        loaded_expr <- apply(scaled.expr[[tx]][,common.tx,drop=FALSE], 1, function(x) x*abs(tx.loadings[[tx]][[gs]][common.tx,1]))
        if(length(dim(loaded_expr)) == 0){next()}
        ind_score <- colMeans(loaded_expr)
        set.score.mat[category_name,] <- ind_score
    }
}

not.na <- which(!is.na(rowSums(set.score.mat)))
set.score.mat <- set.score.mat[not.na,]

pheatmap(set.score.mat, show_colnames = FALSE)
tissue.df <- data.frame("Tissue" = as.factor(sapply(strsplit(rownames(set.score.mat), "_"), function(x) x[1])))
rownames(tissue.df) <- rownames(set.score.mat)

phenotype.order <- reorder_dendrogram(t(set.score.mat), pheno.score)

pheatmap(set.score.mat[,phenotype.order], cluster_cols = FALSE, 
    show_colnames = FALSE, annotation_col = pheno.df, annotation_row = tissue.df)

#abs.max <- apply(set.score.mat, 1, function(x) max(abs(x)))
#plot(sort(abs.max))
```

The gene set profiles have a complex correlation structure,
and the clusters span multiple tissues.

```{r set_cor, fig.width = 10, fig.height = 8}
pheatmap(cor(t(set.score.mat)), show_colnames = FALSE,
    annotation_col = tissue.df)
```


```{r set_pheno_cor, fig.width = 9, fig.height = 10}
bar.cols <- sapply(tissue.df[,1], function(x) tissue.cols[which(tissue.names == x)])
#pdf("~/Desktop/test.pdf", width = 9, height = 20)
trait.set.cor <- apply(set.score.mat, 1, function(x) cor(x, pheno.score[common.ind]))
par(mar = c(4,20,4,4))
cor.order <- order(trait.set.cor)
barplot(trait.set.cor[cor.order], las = 2, horiz = TRUE, col = bar.cols[cor.order])
legend("bottomright", legend = tissue.names, fill = tissue.cols)
#dev.off()
```

```{r set_k}
k = 2
```

The individuals do cluster based on their correlation.
We can cluster this correlation matrix into multiple groups
and look for phenotypic differences as well as cell type differences.
Here we look at `r k` groups.

```{r cluster_cor, fig.width = 7, fig.height = 5}
ind.cor <- cor(set.score.mat)
ind_tree <- hclust(dist(ind.cor))
groups <- cutree(ind_tree, k = k)


#test <- dist(t(cell_type_scores))
#test <- test.pam.k(ind.cor, kseq = 3:15, diss = TRUE, plot.results = FALSE, metric = "euclidean")

#test <- test.pam.k(ind.cor, kseq = 2:15, plot.results = FALSE, metric = "manhattan")
#boxplot(test$cl.width)
#k <- names(which.max(sapply(test$cl.width, mean)))
#groups <- test$mem[,k]

#cor.umap <- umap(ind.cor)
#plot(cor.umap$layout, col = pheno.col, pch = 16)

#test <- test.pam.k(cor.umap$layout, plot.results = FALSE)
#k <- names(which.max(sapply(test$cl.width, mean)))
#groups <- test$mem[,k]
```

The correlation among individuals is shown below 
along with their group assignments based on hierarchical 
clustering. 


```{r group_heat, fig.height = 7, fig.width = 8}
group.df <- data.frame("Group" = as.factor(groups))
group.order <- names(groups)[order(groups)]

#group.order <- reorder_dendrogram(ind.cor, pheno.score)

pheatmap(ind.cor[group.order, group.order], 
    show_rownames = FALSE, show_colnames = FALSE, cluster_rows = FALSE, cluster_cols = FALSE,
    main = "Correlation of individuals by cell type score", annotation_col = group.df)

```

The distribution of phenotypes in each group is shown below.

```{r group_pheno, fig.height = 5, fig.width = 5}
group.idx <- lapply(1:k, function(x) names(groups)[which(groups == x)])
group.pheno <- lapply(group.idx, function(x) pheno.score[x])
names(group.pheno) <- paste0("group", 1:k)
group.order <- order(sapply(group.pheno, mean))

boxplot(group.pheno[group.order], main = "Phenotype Distribution by Group")
abline(h = 0)
```

The distributions of gene set scores in each group
is shown below.

```{r group_cell_types}
#collect cell type means per group
group.mats <- vector(mode = "list", length = k)
names(group.mats) <- paste("Group", 1:k)
for(i in 1:length(group.order)){
    group.mat <- t(set.score.mat[,group.idx[[group.order[i]]]])
    mat.list <- lapply(1:ncol(group.mat), function(x) group.mat[,x])
    names(mat.list) <- colnames(group.mat)
    group.mats[[i]] <- mat.list
    }

plot.grouped.boxes(group.mats, print.vals = NA, plot.grouping = "outer")
```

A different view of these data are shown below. The
heat map shows the mean value for each gene set in 
each group.

```{r cell_type_heat, fig.width = 7, fig.height = 4}
group.means <- sapply(group.mats, function(x) sapply(x, mean))
mean.pheno <- sapply(group.pheno[group.order], mean)
names(mean.pheno) <- names(group.mats)
pheatmap(group.means, cluster_cols = FALSE)
```

